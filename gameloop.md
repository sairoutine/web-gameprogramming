# ゲームループ
Webエンジニアが初めてゲームを作るときにまず戸惑うのが、「ゲームループ」という考え方だと思います。
本稿では、ゲームの画面上の動きがどのようにして更新されていくのかを、「ゲームループ」という考え方でご説明させていただきます。

FPS(frame per second)という言葉を聞いたことがありますでしょうか。「60FPS」「30FPS」という言葉を聞いたことがあるかと思います。60FPSという言葉はどういう意味なのでしょうか。「60FPS」のゲームでは、1秒間に60回、画面が更新されています。つまり、１/60秒ごとに少しずつ違う画面を計算・描画することで、私たちの目に「動画」として映っているのです。下記のコードを見てみてください。

```
function update() {
	// ゲーム更新
}

function run() {
	update();

	window.requestAnimationFrame(run)
}

run();
```

requestAnimationFrameメソッドは、次の再描画の直前に、指定した関数を呼び出すようにブラウザーに要求します。
ブラウザの再描画は基本的に1秒に60回行われるため、上記のコードを書くと、1秒間に60回、update 関数が呼び出されます。

この update 関数の中で、ゲームの描画であったり、描画に必要な情報の更新を行います。

# 処理落ちとフレーム落ち
ゲームループは2種類の実装方法があります。これは、処理に時間がかかった際に「処理落ち」させるか「フレーム落ち」させるかの違いです。

1秒間に60回処理する場合、1処理には最大16.666msしか使用することができません。
それ以上時間、処理に時間をかけた場合に、「処理を遅延させるか」「描画をスキップするか」が
処理落ちとフレーム落ちの違いです。

処理落ちが発生すると、画面の動きがすごくゆっくりになります。画面の動きはゆっくりになりますが、描画はスキップしません。
弾幕シューティングゲームなどは描画がスキップされると、プレイヤーが理解できないまま死んでしまいます。描画がスキップされると困る場合に処理落ちする方のゲームループを使用します。先ほど上げたゲームループは、処理落ちするゲームループです。

フレーム落ちが発生すると、画面の動きがいきなり飛んだように見えます。処理は時間経過どおりに進みます
一方、そのコマの描画を諦めて次のコマの描画に移ると、
本来描画するはずだったコマがスキップされるため、
動画がカクカクっと飛んだ感じになります。
ただリアルタイムとの同期は守られるため、
動き自体が遅くなることはありません。



フレーム落ちさせる場合の処理は以下となります。
```
var deltaTime = 1.0 / 60.0;
var currentTime;
var accumulator;

function update() {
	// ゲーム更新
}

function run() {
	var newTime = performance.now();
	var fTime = (newTime - currentTime) / 1000;

	// あまりにも追いつくための実行回数が増えないようにする
	if (fTime > 0.25) fTime = 0.25;
	var currentTime = newTime;
	accumulator += fTime;

	// 実行回数を増やして処理を追いつかせる
	while (accumulator >= deltaTime) {
		update();
		accumulator -= deltaTime;
	}
	window.requestAnimationFrame(run)
}

run();

```

描画毎に、前回の実行時との経過時間を計算し、16.6ms 以内に処理が収まってなければ、
次の実行時に複数回実行することで、処理を追いつかせています。

